<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
		xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
		layout:decorate="~{layout/layout}">
	<head>
		<title>Assign Employee</title>
		<!-- Read Dedicated CSS -->
		<link rel="stylesheet" th:href="@{/css/user/list.css}">
	</head>
	<body>
		<div layout:fragment="content">
			<div class="header">
				<h1 class="h2">Assign Employee</h1>
				<hr/>
				
				<div class="border">
					<h4 class="px-1 py-2 mb-0 bg-info">Project Detail</h4>
					<form class="pt-3 bg-light pb-3" method="post" th:object="${project}" th:action="@{/project/detail}">
						<input type="hidden" th:field="*{projectId}">
						<table class="table table-borderless mb-0">
							<thead class="table-light">
								<tr>
									<th>Project Name</th>
									<td>
										<input class="form-control w-75" th:field="*{name}" th:onchange="$('#saveBtn').removeAttr('disabled')">
									</td>
								</tr>
								<tr>
									<th>Max Hours</th>
									<td>
										<input class="form-control w-25" th:field="*{maxHours}" th:onchange="$('#saveBtn').removeAttr('disabled')">
									</td>
								</tr>
								<tr>
									<th>Start Date</th>
									<td>
										<input type="date" class="form-control w-50" th:field="*{startDate}" th:onchange="$('#saveBtn').removeAttr('disabled')">
									</td>
								</tr>
								<tr>
									<th>End Date</th>
									<td>
										<input type="date" class="form-control w-50" th:field="*{endDate}" th:onchange="$('#saveBtn').removeAttr('disabled')">
									</td>
								</tr>
								<tr>
									<th></th>
									<td>
										<button name="update" type="submit" id="saveBtn" class="btn btn-primary" disabled>Save changes</button>
										<button name="delete" type="submit" class="btn btn-outline-danger">Delete</button>
									</td>
								</tr>
							</thead>
						</table>
					</form>
				</div>
				<div class="row mt-4">
					<div class="col-12 col-lg-6">
						<h4 class="px-1 py-2 mb-0 bg-info">Employees assigned to the project</h4>
						<form method="post" th:action="@{'/project/detail/' + ${project.projectId} + '/delete'}">
							<div class="table-responsive">
								<table class="table table-striped table-bordered table-hover">
									<thead>
										<tr>
											<th class="th-width">No.</th>
											<th class="th-width">First Name</th>
											<th class="th-width">Last Name</th>
											<th class="th-width">Hours Worked</th>
											<th class="th-width text-center">
												<button type="submit" id="deleteBtn" class="btn btn-danger" disabled>Delete</button>
											</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="item, iter : ${assignedEmployee}">
											<td th:text="${iter.index + 1}"></td>
											<td th:text="${item.firstName}"></td>
											<td th:text="${item.lastName}"></td>
											<td th:text="${item.hoursWorked}"></td>
											<td class="text-center">
												<input class="form-check-input" type="checkbox" name="deleteIds" th:value="${item.employeeId}" 
													th:data-index="${iter.index}" th:onchange="onCheckDeleted(this, this.getAttribute('data-index'))">
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</form>
					</div>
					<div class="col-12 col-lg-6">
						<h4 class="px-1 py-2 mb-0 bg-info">Employees who are assigned to the project</h4>
						<form method="post" th:action="@{'/project/detail/' + ${project.projectId} + '/add'}" th:object="${assignmentFormList}">
							<div class="table-responsive">
								<table class="table table-striped table-bordered table-hover">
									<thead>
										<tr>
											<th class="th-width">No.</th>
											<th class="th-width text-center">
												<button type="submit" id="assignBtn" class="btn btn-primary" disabled>Assign</button>
											</th>
											<th class="th-width">First Name</th>
											<th class="th-width">Last Name</th>
											<th class="th-width">Hours Worked</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="item, iter : ${notAssignedEmployee}">
											<td class="d-none">
												<input type="hidden" th:name="${'assignments['+__${iter.index}__+'].employeeId'}"
													th:id="${'assignments'+__${iter.index}__+'.employeeId'}" th:value="${item.employeeId}">
											</td>
											<td th:text="${iter.index + 1}"></td>
											<td class="text-center">
												<input type="checkbox" th:name="${'assignments['+__${iter.index}__+'].isChecked'}" class="form-check-input" 
													th:id="${'assignments'+__${iter.index}__+'.isChecked'}" th:value="1" 
													th:data-index="${iter.index}" th:onchange="onCheckAssigned(this, this.getAttribute('data-index'))">
											</td>
											<td th:text="${item.firstName}"></td>
											<td th:text="${item.lastName}"></td>
											<td>
												<input type="text" class="form-control" th:field="*{assignments[__${iter.index}__].hoursWorked}">
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</form>
					</div>
				</div>
			</div>
			
			<!-- Toast alert -->
			<div class="position-fixed top-0 end-0 p-3 mt-4" style="z-index: 11">
				<div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
				  	<div class="toast-body bg-light text-success fw-bold fs-6 rounded">
				   		Data has been changed successfully.
				    </div>
				</div>
			</div>
			
			<!-- Custom JS -->
			<script type="text/javascript">
				let assignIdx = [];
				let deleteIdx = [];
				
				function onCheckAssigned(element, index) {
					if (element.checked) {
						assignIdx.push(index);
					} else {
						assignIdx = assignIdx.filter(item => item != index);
					}
					
					if (assignIdx.length == 0) {
						$('#assignBtn').attr('disabled', 'disabled');
					} else {
						$('#assignBtn').removeAttr('disabled');
					}
				}
				
				function onCheckDeleted(element, index) {
					if (element.checked) {
						deleteIdx.push(index);
					} else {
						deleteIdx = deleteIdx.filter(item => item != index);
					}
					
					if (deleteIdx.length == 0) {
						$('#deleteBtn').attr('disabled', 'disabled');
					} else {
						$('#deleteBtn').removeAttr('disabled');
					}
				}
			</script>
			
			<!-- Thymeleaf JS -->
			<script th:inline="javascript">
				/*<![CDATA[*/
				    let showToast = /*[[${showToast}]]*/ '';
				    
				    window.onload = (event) => {
						 if (showToast == 1) {
							 let myAlert = document.querySelector('.toast');
							 let bsAlert = new bootstrap.Toast(myAlert);
							 bsAlert.show();
						 }
					}
				/*]]>*/
			</script>
		</div>
	</body>
</html>